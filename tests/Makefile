# æµ‹è¯•ç›®å½• Makefile
# æä¾›ä¾¿æ·çš„æµ‹è¯•è¿è¡Œå‘½ä»¤

.PHONY: help test test-all test-unit test-integration test-performance test-api test-scraping test-database test-analysis clean report

# é»˜è®¤ç›®æ ‡
help:
	@echo "ğŸš€ Liblib Transportation Analysis æµ‹è¯•å·¥å…·"
	@echo "=========================================="
	@echo ""
	@echo "å¯ç”¨å‘½ä»¤:"
	@echo "  test          - è¿è¡Œæ‰€æœ‰æµ‹è¯•"
	@echo "  test-all      - è¿è¡Œæ‰€æœ‰æµ‹è¯•ï¼ˆè¯¦ç»†æ¨¡å¼ï¼‰"
	@echo "  test-unit     - è¿è¡Œå•å…ƒæµ‹è¯•"
	@echo "  test-integration - è¿è¡Œé›†æˆæµ‹è¯•"
	@echo "  test-performance - è¿è¡Œæ€§èƒ½æµ‹è¯•"
	@echo "  test-api      - è¿è¡ŒAPIæµ‹è¯•"
	@echo "  test-scraping - è¿è¡Œé‡‡é›†æµ‹è¯•"
	@echo "  test-database - è¿è¡Œæ•°æ®åº“æµ‹è¯•"
	@echo "  test-analysis - è¿è¡Œåˆ†ææµ‹è¯•"
	@echo "  pytest        - ä½¿ç”¨pytestè¿è¡Œæµ‹è¯•"
	@echo "  pytest-unit   - ä½¿ç”¨pytestè¿è¡Œå•å…ƒæµ‹è¯•"
	@echo "  pytest-integration - ä½¿ç”¨pytestè¿è¡Œé›†æˆæµ‹è¯•"
	@echo "  report        - ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š"
	@echo "  clean         - æ¸…ç†æµ‹è¯•è¾“å‡º"
	@echo "  help          - æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯"
	@echo ""

# è¿è¡Œæ‰€æœ‰æµ‹è¯•
test:
	@echo "ğŸ§ª è¿è¡Œæ‰€æœ‰æµ‹è¯•..."
	python run_tests.py

# è¿è¡Œæ‰€æœ‰æµ‹è¯•ï¼ˆè¯¦ç»†æ¨¡å¼ï¼‰
test-all:
	@echo "ğŸ§ª è¿è¡Œæ‰€æœ‰æµ‹è¯•ï¼ˆè¯¦ç»†æ¨¡å¼ï¼‰..."
	python run_tests.py --report

# è¿è¡Œå•å…ƒæµ‹è¯•
test-unit:
	@echo "ğŸ§ª è¿è¡Œå•å…ƒæµ‹è¯•..."
	python run_tests.py --type unit

# è¿è¡Œé›†æˆæµ‹è¯•
test-integration:
	@echo "ğŸ”— è¿è¡Œé›†æˆæµ‹è¯•..."
	python run_tests.py --type integration

# è¿è¡Œæ€§èƒ½æµ‹è¯•
test-performance:
	@echo "âš¡ è¿è¡Œæ€§èƒ½æµ‹è¯•..."
	python run_tests.py --test tests/integration/test_performance.py

# è¿è¡ŒAPIæµ‹è¯•
test-api:
	@echo "ğŸŒ è¿è¡ŒAPIæµ‹è¯•..."
	python run_tests.py --test tests/integration/test_api_collection.py

# è¿è¡Œé‡‡é›†æµ‹è¯•
test-scraping:
	@echo "ğŸ“¡ è¿è¡Œé‡‡é›†æµ‹è¯•..."
	python run_tests.py --test tests/integration/test_data_collection.py

# è¿è¡Œæ•°æ®åº“æµ‹è¯•
test-database:
	@echo "ğŸ—„ï¸  è¿è¡Œæ•°æ®åº“æµ‹è¯•..."
	pytest tests/ -m database -v

# è¿è¡Œåˆ†ææµ‹è¯•
test-analysis:
	@echo "ğŸ“Š è¿è¡Œåˆ†ææµ‹è¯•..."
	pytest tests/ -m analysis -v

# ä½¿ç”¨pytestè¿è¡Œæ‰€æœ‰æµ‹è¯•
pytest:
	@echo "ğŸ ä½¿ç”¨pytestè¿è¡Œæ‰€æœ‰æµ‹è¯•..."
	pytest tests/ -v

# ä½¿ç”¨pytestè¿è¡Œå•å…ƒæµ‹è¯•
pytest-unit:
	@echo "ğŸ ä½¿ç”¨pytestè¿è¡Œå•å…ƒæµ‹è¯•..."
	pytest tests/unit/ -v

# ä½¿ç”¨pytestè¿è¡Œé›†æˆæµ‹è¯•
pytest-integration:
	@echo "ğŸ ä½¿ç”¨pytestè¿è¡Œé›†æˆæµ‹è¯•..."
	pytest tests/integration/ -v

# è¿è¡Œç‰¹å®šæµ‹è¯•æ–‡ä»¶
test-file:
	@if [ -z "$(FILE)" ]; then \
		echo "âŒ è¯·æŒ‡å®šæµ‹è¯•æ–‡ä»¶: make test-file FILE=path/to/test.py"; \
		exit 1; \
	fi
	@echo "ğŸ¯ è¿è¡Œç‰¹å®šæµ‹è¯•æ–‡ä»¶: $(FILE)"
	python run_tests.py --test $(FILE)

# è¿è¡Œæ ‡è®°çš„æµ‹è¯•
test-marked:
	@if [ -z "$(MARK)" ]; then \
		echo "âŒ è¯·æŒ‡å®šæµ‹è¯•æ ‡è®°: make test-marked MARK=unit"; \
		exit 1; \
	fi
	@echo "ğŸ·ï¸  è¿è¡Œæ ‡è®°ä¸º $(MARK) çš„æµ‹è¯•..."
	pytest tests/ -m $(MARK) -v

# ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
report:
	@echo "ğŸ“‹ ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š..."
	python run_tests.py --report

# è¿è¡Œè¦†ç›–ç‡æµ‹è¯•
coverage:
	@echo "ğŸ“Š è¿è¡Œè¦†ç›–ç‡æµ‹è¯•..."
	pytest tests/ --cov=src --cov-report=html --cov-report=term-missing

# è¿è¡Œæ…¢é€Ÿæµ‹è¯•
test-slow:
	@echo "ğŸŒ è¿è¡Œæ…¢é€Ÿæµ‹è¯•..."
	pytest tests/ --run-slow -v

# è¿è¡Œæ€§èƒ½æµ‹è¯•ï¼ˆpytestï¼‰
test-perf-pytest:
	@echo "âš¡ ä½¿ç”¨pytestè¿è¡Œæ€§èƒ½æµ‹è¯•..."
	pytest tests/ --run-performance -v

# è¿è¡Œé›†æˆæµ‹è¯•ï¼ˆpytestï¼‰
test-int-pytest:
	@echo "ğŸ”— ä½¿ç”¨pytestè¿è¡Œé›†æˆæµ‹è¯•..."
	pytest tests/ --run-integration -v

# æ¸…ç†æµ‹è¯•è¾“å‡º
clean:
	@echo "ğŸ§¹ æ¸…ç†æµ‹è¯•è¾“å‡º..."
	rm -rf ../test_output/*
	rm -rf .pytest_cache/
	rm -rf __pycache__/
	find . -name "*.pyc" -delete
	find . -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true
	@echo "âœ… æ¸…ç†å®Œæˆ"

# æ£€æŸ¥æµ‹è¯•ç¯å¢ƒ
check-env:
	@echo "ğŸ” æ£€æŸ¥æµ‹è¯•ç¯å¢ƒ..."
	@python -c "import pytest; print('âœ… pytest å·²å®‰è£…')" || echo "âŒ pytest æœªå®‰è£…"
	@python -c "import requests; print('âœ… requests å·²å®‰è£…')" || echo "âŒ requests æœªå®‰è£…"
	@python -c "import psutil; print('âœ… psutil å·²å®‰è£…')" || echo "âŒ psutil æœªå®‰è£…"
	@echo "ğŸ“‹ ç¯å¢ƒæ£€æŸ¥å®Œæˆ"

# å®‰è£…æµ‹è¯•ä¾èµ–
install-deps:
	@echo "ğŸ“¦ å®‰è£…æµ‹è¯•ä¾èµ–..."
	pip install pytest pytest-cov requests psutil

# å¿«é€Ÿæµ‹è¯•ï¼ˆåªè¿è¡Œå…³é”®æµ‹è¯•ï¼‰
test-quick:
	@echo "âš¡ å¿«é€Ÿæµ‹è¯•ï¼ˆåªè¿è¡Œå…³é”®æµ‹è¯•ï¼‰..."
	python run_tests.py --type unit
	@echo "âœ… å¿«é€Ÿæµ‹è¯•å®Œæˆ"

# å®Œæ•´æµ‹è¯•å¥—ä»¶
test-suite:
	@echo "ğŸ¯ è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶..."
	@echo "1ï¸âƒ£ è¿è¡Œå•å…ƒæµ‹è¯•..."
	make test-unit
	@echo "2ï¸âƒ£ è¿è¡Œé›†æˆæµ‹è¯•..."
	make test-integration
	@echo "3ï¸âƒ£ ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š..."
	make report
	@echo "âœ… å®Œæ•´æµ‹è¯•å¥—ä»¶å®Œæˆ"

# è°ƒè¯•æ¨¡å¼è¿è¡Œ
test-debug:
	@echo "ğŸ› è°ƒè¯•æ¨¡å¼è¿è¡Œæµ‹è¯•..."
	pytest tests/ -v -s --pdb

# å¹¶è¡Œè¿è¡Œæµ‹è¯•
test-parallel:
	@echo "ğŸ”„ å¹¶è¡Œè¿è¡Œæµ‹è¯•..."
	pytest tests/ -n auto -v

# æ˜¾ç¤ºæµ‹è¯•ç»Ÿè®¡
test-stats:
	@echo "ğŸ“Š æ˜¾ç¤ºæµ‹è¯•ç»Ÿè®¡..."
	pytest tests/ --collect-only -q

# éªŒè¯æµ‹è¯•ç»“æ„
validate:
	@echo "ğŸ” éªŒè¯æµ‹è¯•ç»“æ„..."
	@echo "æ£€æŸ¥å¿…è¦çš„æµ‹è¯•æ–‡ä»¶..."
	@test -f run_tests.py && echo "âœ… run_tests.py å­˜åœ¨" || echo "âŒ run_tests.py ç¼ºå¤±"
	@test -f conftest.py && echo "âœ… conftest.py å­˜åœ¨" || echo "âŒ conftest.py ç¼ºå¤±"
	@test -d unit && echo "âœ… unit/ ç›®å½•å­˜åœ¨" || echo "âŒ unit/ ç›®å½•ç¼ºå¤±"
	@test -d integration && echo "âœ… integration/ ç›®å½•å­˜åœ¨" || echo "âŒ integration/ ç›®å½•ç¼ºå¤±"
	@test -d fixtures && echo "âœ… fixtures/ ç›®å½•å­˜åœ¨" || echo "âŒ fixtures/ ç›®å½•ç¼ºå¤±"
	@echo "ğŸ“‹ ç»“æ„éªŒè¯å®Œæˆ"

# é»˜è®¤ç›®æ ‡
.DEFAULT_GOAL := help
